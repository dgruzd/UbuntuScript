<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">

<head profile="http://gmpg.org/xfn/11">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Capistrano and database.yml  &#8211;  Simone Carletti&#039;s Blog</title>

    <meta name="description" content="How to create the database.yml file with Capistrano to prevent sensitive data to be stored in the application repository." />
  
  <link rel="profile" href="http://gmpg.org/xfn/11" />
  <link rel="stylesheet" type="text/css" media="all" href="http://www.simonecarletti.com/blog/wp-content/themes/my/style.css" />
  <link rel="pingback" href="http://www.simonecarletti.com/blog/xmlrpc.php" />
  <link rel="search" type="application/opensearchdescription+xml" title="SimoneCarletti.com" href="/opensearch.xml">

  <link href="/assets/application.css" media="screen" rel="stylesheet" type="text/css" />

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>

  <script src="http://www.simonecarletti.com/blog/wp-content/themes/my/blog.js" type="text/javascript"></script>

    <script type="text/javascript">
	window.google_analytics_uacct = "UA-53225-16";
</script>
<link rel="alternate" type="application/rss+xml" title="Simone Carletti&#039;s Blog &raquo; Feed" href="http://www.simonecarletti.com/blog/feed/" />
<link rel="alternate" type="application/rss+xml" title="Simone Carletti&#039;s Blog &raquo; Comments Feed" href="http://www.simonecarletti.com/blog/comments/feed/" />
				
	<script type="text/javascript">//<![CDATA[
	// Google Analytics for WordPress by Yoast v4.2.2 | http://yoast.com/wordpress/google-analytics/
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount','UA-53225-16']);
	_gaq.push(['_trackPageview'],['_trackPageLoadTime']);
	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
	//]]></script>
<link rel="alternate" type="application/rss+xml" title="Simone Carletti&#039;s Blog &raquo; Capistrano and database.yml Comments Feed" href="http://www.simonecarletti.com/blog/2009/06/capistrano-and-database-yml/feed/" />
<style type="text/css">.codecolorer-container {
  border: 1px solid #ddd !important;
}

.codecolorer-container, .codecolorer {
  background-color: whiteSmoke !important;
}

.codecolorer, .codecolorer *, .codecolorer-container, .codecolorer-container * {
  font: 12px/1.4em Monaco, Lucida Console, monospace !important;
}

.codecolorer-container table {
  margin-bottom: 0px;
}</style>
<link rel='stylesheet' id='codecolorer-css'  href='http://www.simonecarletti.com/blog/wp-content/plugins/codecolorer/codecolorer.css?ver=0.9.9' type='text/css' media='screen' />
<script type='text/javascript' src='http://www.simonecarletti.com/blog/wp-includes/js/comment-reply.js?ver=20090102'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.simonecarletti.com/blog/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.simonecarletti.com/blog/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='When did Virgilio blacklist Gmail?' href='http://www.simonecarletti.com/blog/2009/05/when-did-virgilio-blacklist-gmail/' />
<link rel='next' title='Adding Ruby Enterprise Edition to multiruby versions' href='http://www.simonecarletti.com/blog/2009/06/adding-ruby-enterprise-edition-to-multiruby-versions/' />
<meta name="generator" content="WordPress 3.3" />
<link rel='canonical' href='http://www.simonecarletti.com/blog/2009/06/capistrano-and-database-yml/' />
<link rel='shortlink' href='http://www.simonecarletti.com/blog/?p=363' />
	<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>

<!-- Wordpress Popular Posts v2.2.1 -->
<link rel="stylesheet" href="http://www.simonecarletti.com/blog/wp-content/plugins/wordpress-popular-posts/style/wpp.css" type="text/css" media="screen" />
<!-- End Wordpress Popular Posts v2.2.1 -->
<!-- Wordpress Popular Posts v2.2.1 -->
<script type="text/javascript" charset="utf-8">
    /* <![CDATA[ */				
	jQuery.post('http://www.simonecarletti.com/blog/wp-admin/admin-ajax.php', {action: 'wpp_update', token: '4d1428e05c', id: 363});
    /* ]]> */
</script>
<!-- End Wordpress Popular Posts v2.2.1 -->
            </head>

<body class="single single-post postid-363 single-format-standard site-blog lang-en">

  <div id="header" class="container_12 clearfix">
    <div id="logo" class="grid_8">
      <a href="http://www.simonecarletti.com/blog/">Simone Carletti <em class="target-blog">'s Blog</em></a>
    </div>
    <div id="menu" class="grid_4">
      <ul id="nav">
        <li><a href="/" class="target-home">Home</a></li>
        <li><a href="/blog" class="target-blog">Blog</a></li>
        <li><a href="http://code.simonecarletti.com/" class="target-code">Code</a></li>
        <li><a href="/quotes" class="target-quotes">Quotes</a></li>
      </ul>
    </div>
  </div>

  <hr class="single separator_12" />

  <div id="content" class="container_12 clearfix">
    <div class="grid_8">

  <div class="post-363 post type-post status-publish format-standard hentry category-programming tag-capistrano tag-database tag-programming tag-rails tag-ruby tag-security" id="post-363">
    <h1 class="title">Capistrano and database.yml</h1>
    <p class="meta">
      June 3rd, 2009 at 7:06 am •
      <a href="http://www.simonecarletti.com/blog/2009/06/capistrano-and-database-yml/" rel="bookmark" title="Permanent Link to Capistrano and database.yml">permalink</a> •
      <a href="http://www.simonecarletti.com/blog/2009/06/capistrano-and-database-yml/#comments" title="Comment on Capistrano and database.yml">10 comments</a>          </p>
    <div class="entry">
      <p><img class="alignleft size-full wp-image-374" title="Capistrano logo" src="http://www.simonecarletti.com/blog/wp-content/uploads/2009/06/capistrano-logo.png" alt="Capistrano logo" width="150" height="57" />Last week, an user asked the <a href="http://www.capify.org/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.capify.org']);">Capistrano</a> mailing list about <a href="http://groups.google.com/group/capistrano/browse_thread/thread/3a71f99570647caf#" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://groups.google.com']);">database password best practices</a>. This reminded me that I never posted here a Capistrano recipe I created almost one year ago to solve exactly this problem.</p>
<p>Which problem?</p>
<p>Imagine you need to deploy a new Rails application. As you probably know, Rails stores all the database configurations in a single file called <code>config/database.yml</code>, including database authentication credentials.</p>
<p>This file usually lives in your repository along with all your application code base. However, <strong>exposing real world passwords to all developers</strong> with read access to the repository can lead to <strong>major security problems</strong>. It&#8217;s likely you don&#8217;t want to store sensitive data in your repository, thus you need to automatically generate the config.yml file somehow on deploy or on setup.</p>
<p>If you are using Capistrano to deploy your Rails application, you <strong>can ask Capistrano to generate and upload the file for you</strong>. Let me show you how.<span id="more-363"></span></p>
<h2>One Problem, Many Solutions</h2>
<p>As usual, one problem comes with many different solution. That&#8217;s good because this is definitely better than a problem without a reasonable solution&#8230; do you agree?</p>
<p>As Robert James pointed out in its email, there are at least 3 different approaches to solve this issue.</p>
<ul>
<li>You can <strong>store sensitive data in your Capistrano deploy script.</strong> The downside of this solutions is that every developer with read access to the Capistrano script have access to the data as well.</li>
<li>You can <strong>store sensitive data on your server</strong>, but it requires some kind of manual setup.</li>
<li>You can <strong>use a password-less system</strong>, but this is probably the worst idea ever. Don&#8217;t misunderstand me, shared keys are a wonderful authentication system and I widely use them, but I didn&#8217;t find an effective alternative for database authentication.</li>
</ul>
<p>My recipes combines the second choice with some additional features, taking advantage of Capistrano ability to execute commands simultaneously on multiple servers.</p>
<h2>Capistrano database.yml task</h2>
<p>The recipe is <a href="http://gist.github.com/2769" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://gist.github.com']);">available as a gist</a>. I think it is fairly self-explanatory and the documentation section at the beginning should give you a good overview of how it works.</p>
<div class="codecolorer-container text default code-ruby" style="overflow:auto;white-space:nowrap;height:300px;"><table cellspacing="0" cellpadding="0"><tbody><tr><td class="line-numbers"><div>1<br />2<br />3<br />4<br />5<br />6<br />7<br />8<br />9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21<br />22<br />23<br />24<br />25<br />26<br />27<br />28<br />29<br />30<br />31<br />32<br />33<br />34<br />35<br />36<br />37<br />38<br />39<br />40<br />41<br />42<br />43<br />44<br />45<br />46<br />47<br />48<br />49<br />50<br />51<br />52<br />53<br />54<br />55<br />56<br />57<br />58<br />59<br />60<br />61<br />62<br />63<br />64<br />65<br />66<br />67<br />68<br />69<br />70<br />71<br />72<br />73<br />74<br />75<br />76<br />77<br />78<br />79<br /></div></td><td><div class="text codecolorer">#<br />
# = Capistrano database.yml task<br />
#<br />
# Provides a couple of tasks for creating the database.yml<br />
# configuration file dynamically when deploy:setup is run.<br />
#<br />
# Category:: &nbsp; &nbsp;Capistrano<br />
# Package:: &nbsp; &nbsp; Database<br />
# Author:: &nbsp; &nbsp; &nbsp;Simone Carletti<br />
# Copyright:: &nbsp; 2007-2009 The Authors<br />
# License:: &nbsp; &nbsp; MIT License<br />
# Link:: &nbsp; &nbsp; &nbsp; &nbsp;http://www.simonecarletti.com/<br />
# Source:: &nbsp; &nbsp; &nbsp;http://gist.github.com/2769<br />
#<br />
#<br />
<br />
unless Capistrano::Configuration.respond_to?(:instance)<br />
&nbsp; abort &quot;This extension requires Capistrano 2&quot;<br />
end<br />
<br />
Capistrano::Configuration.instance.load do<br />
<br />
&nbsp; namespace :db do<br />
<br />
&nbsp; &nbsp; desc &lt;&lt;-DESC<br />
&nbsp; &nbsp; &nbsp; Creates the database.yml configuration file in shared path.<br />
<br />
&nbsp; &nbsp; &nbsp; By default, this task uses a template unless a template <br />
&nbsp; &nbsp; &nbsp; called database.yml.erb is found either is :template_dir <br />
&nbsp; &nbsp; &nbsp; or /config/deploy folders. The default template matches <br />
&nbsp; &nbsp; &nbsp; the template for config/database.yml file shipped with Rails.<br />
<br />
&nbsp; &nbsp; &nbsp; When this recipe is loaded, db:setup is automatically configured <br />
&nbsp; &nbsp; &nbsp; to be invoked after deploy:setup. You can skip this task setting <br />
&nbsp; &nbsp; &nbsp; the variable :skip_db_setup to true. This is especially useful <br />
&nbsp; &nbsp; &nbsp; if you are using this recipe in combination with <br />
&nbsp; &nbsp; &nbsp; capistrano-ext/multistaging to avoid multiple db:setup calls <br />
&nbsp; &nbsp; &nbsp; when running deploy:setup for all stages one by one.<br />
&nbsp; &nbsp; DESC<br />
&nbsp; &nbsp; task :setup, :except =&gt; { :no_release =&gt; true } do<br />
<br />
&nbsp; &nbsp; &nbsp; default_template = &lt;&lt;-EOF<br />
&nbsp; &nbsp; &nbsp; base: &amp;base<br />
&nbsp; &nbsp; &nbsp; &nbsp; adapter: sqlite3<br />
&nbsp; &nbsp; &nbsp; &nbsp; timeout: 5000<br />
&nbsp; &nbsp; &nbsp; development:<br />
&nbsp; &nbsp; &nbsp; &nbsp; database: #{shared_path}/db/development.sqlite3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &lt;&lt;: *base<br />
&nbsp; &nbsp; &nbsp; test:<br />
&nbsp; &nbsp; &nbsp; &nbsp; database: #{shared_path}/db/test.sqlite3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &lt;&lt;: *base<br />
&nbsp; &nbsp; &nbsp; production:<br />
&nbsp; &nbsp; &nbsp; &nbsp; database: #{shared_path}/db/production.sqlite3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &lt;&lt;: *base<br />
&nbsp; &nbsp; &nbsp; EOF<br />
<br />
&nbsp; &nbsp; &nbsp; location = fetch(:template_dir, &quot;config/deploy&quot;) + '/database.yml.erb'<br />
&nbsp; &nbsp; &nbsp; template = File.file?(location) ? File.read(location) : default_template<br />
<br />
&nbsp; &nbsp; &nbsp; config = ERB.new(template)<br />
<br />
&nbsp; &nbsp; &nbsp; run &quot;mkdir -p #{shared_path}/db&quot;<br />
&nbsp; &nbsp; &nbsp; run &quot;mkdir -p #{shared_path}/config&quot;<br />
&nbsp; &nbsp; &nbsp; put config.result(binding), &quot;#{shared_path}/config/database.yml&quot;<br />
&nbsp; &nbsp; end<br />
<br />
&nbsp; &nbsp; desc &lt;&lt;-DESC<br />
&nbsp; &nbsp; &nbsp; [internal] Updates the symlink for database.yml file to the just deployed release.<br />
&nbsp; &nbsp; DESC<br />
&nbsp; &nbsp; task :symlink, :except =&gt; { :no_release =&gt; true } do<br />
&nbsp; &nbsp; &nbsp; run &quot;ln -nfs #{shared_path}/config/database.yml #{release_path}/config/database.yml&quot;<br />
&nbsp; &nbsp; end<br />
<br />
&nbsp; end<br />
<br />
&nbsp; after &quot;deploy:setup&quot;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;db:setup&quot; &nbsp; unless fetch(:skip_db_setup, false)<br />
&nbsp; after &quot;deploy:finalize_update&quot;, &quot;db:symlink&quot;<br />
<br />
end</div></td></tr></tbody></table></div>
<p>The following instructions basically represents the documentation you can find at the top of the <a href="http://gist.github.com/2769" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://gist.github.com']);">original recipe</a>.</p>
<h3>Requirements</h3>
<p>This extension requires the original <code>config/database.yml</code> to be excluded from version control. You can easily accomplish this by renaming the file (for example to database.example.yml) and configuring your SCM in order to ignore the <code>database.yml</code> file.</p>
<p>The following example demonstrate how to rename the file and ignore the original one with Subversion.</p>
<div class="codecolorer-container text default code-ruby" style="overflow:auto;white-space:nowrap;"><table cellspacing="0" cellpadding="0"><tbody><tr><td class="line-numbers"><div>1<br />2<br /></div></td><td><div class="text codecolorer">$ svn mv config/database.yml config/database.example.yml<br />
$ svn propset svn:ignore 'database.yml' config</div></td></tr></tbody></table></div>
<p>If your repository is powered by Git, type the following commands.</p>
<div class="codecolorer-container text default code-ruby" style="overflow:auto;white-space:nowrap;"><table cellspacing="0" cellpadding="0"><tbody><tr><td class="line-numbers"><div>1<br />2<br /></div></td><td><div class="text codecolorer">$ git mv config/database.yml config/database.example.yml<br />
$ echo 'config/database.yml' &gt;&gt; .gitignore</div></td></tr></tbody></table></div>
<p>If you don&#8217;t want to rename your file, there&#8217;s an other alternative. You can customize the recipe in order to force Capistrano to delete <code>database.yml</code> file after a successful <code>deploy:code_update</code> and before running the <code>database:symlink</code> task.</p>
<h3>Usage</h3>
<p>Include this file in your <code>deploy.rb</code> configuration file. Assuming you saved this recipe as <code>capistrano_database.rb</code>:</p>
<div class="codecolorer-container text default code-ruby" style="overflow:auto;white-space:nowrap;"><table cellspacing="0" cellpadding="0"><tbody><tr><td class="line-numbers"><div>1<br /></div></td><td><div class="text codecolorer">require &quot;capistrano_database&quot;</div></td></tr></tbody></table></div>
<p>Now, when <code>deploy:setup</code> is called, this script will automatically create the <code>database.yml</code> file in the shared folder.<br />
Each time you run a new deploy, this script will also create a symlink from your application <code>config/database.yml</code> pointing to the shared configuration file.</p>
<p>In case you need to run <code>deploy:setup</code> again and you don&#8217;t want Capistrano to ask for a database password, set the <code>skip_db_setup</code> option to true. This is especially useful in combination with capistrano multi-stage recipe when you already setup your server and you share the same environment across all the stages.</p>
<div class="codecolorer-container text default code-ruby" style="overflow:auto;white-space:nowrap;"><table cellspacing="0" cellpadding="0"><tbody><tr><td class="line-numbers"><div>1<br /></div></td><td><div class="text codecolorer">$ cap deploy:setup -s &quot;skip_db_setup=true&quot;</div></td></tr></tbody></table></div>
<h3>Custom template</h3>
<p>By default, this script creates an exact copy of the default <code>database.yml</code> file shipped with a new Rails 2.x application.<br />
If you want to overwrite the default template, simply create a custom Erb template called <code>database.yml.erb</code> and save it into <code>config/deploy</code> folder.</p>
<p>Although the name of the file can&#8217;t be changed, you can customize the directory where it is stored defining a variable called <code>:template_dir</code>.</p>
<div class="codecolorer-container text default code-ruby" style="overflow:auto;white-space:nowrap;height:300px;"><table cellspacing="0" cellpadding="0"><tbody><tr><td class="line-numbers"><div>1<br />2<br />3<br />4<br />5<br />6<br />7<br />8<br />9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21<br /></div></td><td><div class="text codecolorer"># store your custom template at foo/bar/database.yml.erb<br />
set :template_dir, &quot;foo/bar&quot;<br />
#<br />
# example of database template<br />
<br />
base: &amp;base<br />
&nbsp; adapter: sqlite3<br />
&nbsp; timeout: 5000<br />
development:<br />
&nbsp; database: #{shared_path}/db/development.sqlite3<br />
&nbsp; &lt;&lt;: *base<br />
test:<br />
&nbsp; database: #{shared_path}/db/test.sqlite3<br />
&nbsp; &lt;&lt;: *base<br />
production:<br />
&nbsp; adapter: mysql<br />
&nbsp; database: #{application}_production<br />
&nbsp; username: #{user}<br />
&nbsp; password: #{Capistrano::CLI.ui.ask(&quot;Enter MySQL database password: &quot;)}<br />
&nbsp; encoding: utf8<br />
&nbsp; timeout: 5000</div></td></tr></tbody></table></div>
<p>Because this is an Erb template, you can place variables and Ruby scripts within the file.</p>
<p>For instance, the template above takes advantage of Capistrano CLI to ask for a MySQL database password instead of hard coding it into the template. This solves the original problem of storing sensitive data in your repository or deploy script.</p>
<h3 id="related-posts">Related posts</h3><ol>
<li><a href='http://www.simonecarletti.com/blog/2009/02/capistrano-uploads-folder/' rel='bookmark' title='Capistrano: Managing an uploads folder'>Capistrano: Managing an uploads folder</a></li>
<li><a href='http://www.simonecarletti.com/blog/2008/12/capistrano-deploy-recipe-with-passenger-mod_rails-taste/' rel='bookmark' title='Running Capistrano with Passenger (mod_rails)'>Running Capistrano with Passenger (mod_rails)</a></li>
<li><a href='http://www.simonecarletti.com/blog/2010/07/capistrano-executing-a-command-as-root-without-using-sudo/' rel='bookmark' title='Capistrano: Executing a command as root without using sudo'>Capistrano: Executing a command as root without using sudo</a></li>
<li><a href='http://www.simonecarletti.com/blog/2011/02/how-to-restart-god-when-you-deploy-a-new-release/' rel='bookmark' title='How to restart God when you deploy a new release via Capistrano'>How to restart God when you deploy a new release via Capistrano</a></li>
<li><a href='http://www.simonecarletti.com/blog/2009/09/capistrano-file-transfer-actions/' rel='bookmark' title='Capistrano: File Transfer actions'>Capistrano: File Transfer actions</a></li>
</ol>          </div>
    <p class="meta">
      Filed in <a href="http://www.simonecarletti.com/blog/categories/programming/" title="View all posts in Programming" rel="category tag">Programming</a> •
      Tags: <a href="http://www.simonecarletti.com/blog/tags/capistrano/" rel="tag">capistrano</a>, <a href="http://www.simonecarletti.com/blog/tags/database/" rel="tag">database</a>, <a href="http://www.simonecarletti.com/blog/tags/programming/" rel="tag">Programming</a>, <a href="http://www.simonecarletti.com/blog/tags/rails/" rel="tag">rails</a>, <a href="http://www.simonecarletti.com/blog/tags/ruby/" rel="tag">ruby</a>, <a href="http://www.simonecarletti.com/blog/tags/security/" rel="tag">security</a>    </p>
    <div class="sharing">

<!-- sharing facebook -->
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<div class="fb-like" data-send="true" data-width="350" data-show-faces="false"></div>
<!-- /sharing facebook -->

<!-- sharing g+ -->
<!-- Place this tag where you want the +1 button to render -->
<g:plusone></g:plusone>

<!-- Place this render call where appropriate -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<!-- /sharing g+ -->

<!-- sharing twitter -->
<a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="weppos">Tweet</a><script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
<!-- /sharing twitter -->

    </div>
  </div>

  
  <h3 id="comments">Comments</h3>

  <div class="navigation">
    <div class="alignleft"></div>
    <div class="alignright"></div>
  </div>

  <div class="commentlist">
    		<div class="comment even thread-even depth-1" id="comment-3079">
				<div class="comment-author vcard">
		<img alt='' src='http://1.gravatar.com/avatar/31b5b1c264dbbc3a54215449b5795e3e?s=32&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D32&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn">Mark</cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="http://www.simonecarletti.com/blog/2009/06/capistrano-and-database-yml/#comment-3079">
			June 14, 2009 at 5:19 pm</a>		</div>

		<p>Hey, this was exactly what I was looking for!<br />
Thank you very much for sharing this recipe.</p>
<p>Looking forward to more articles about Capistrano. :)</p>

		<div class="reply">
		<a class='comment-reply-link' href='/blog/2009/06/capistrano-and-database-yml/?replytocom=3079#respond' onclick='return addComment.moveForm("comment-3079", "3079", "respond", "363")'>Reply</a>		</div>
		</div>
		<div class="comment odd alt thread-odd thread-alt depth-1" id="comment-4579">
				<div class="comment-author vcard">
		<img alt='' src='http://0.gravatar.com/avatar/a80b03b2036a8832fe77fa65c4c309fb?s=32&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D32&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn"><a href="http://www.blaenkdenum.com" onclick="javascript:_gaq.push(['_trackEvent','outbound-commentauthor','http://www.blaenkdenum.com']);"  rel='external nofollow' class='url'>Blaenk</a></cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="http://www.simonecarletti.com/blog/2009/06/capistrano-and-database-yml/#comment-4579">
			September 19, 2009 at 7:25 am</a>		</div>

		<p>Thanks for the great script. For some reason though, the external file method did not work for me. The file was copied and all perfectly fine, but when I viewed it on my server, the variables were never expanded (<em>It still showed #{var} and it didn&#8217;t ask me for the password</em>). After copying/pasting the contents of the file into the HERE document directive, everything worked fine.</p>
<p>Thanks again I appreciate it.</p>

		<div class="reply">
		<a class='comment-reply-link' href='/blog/2009/06/capistrano-and-database-yml/?replytocom=4579#respond' onclick='return addComment.moveForm("comment-4579", "4579", "respond", "363")'>Reply</a>		</div>
		</div>
		<div class="comment even thread-even depth-1" id="comment-4762">
				<div class="comment-author vcard">
		<img alt='' src='http://0.gravatar.com/avatar/46e90f9d455a20f330146c471046e1b8?s=32&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D32&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn"><a href="http://www.subtlysimple.com" onclick="javascript:_gaq.push(['_trackEvent','outbound-commentauthor','http://www.subtlysimple.com']);"  rel='external nofollow' class='url'>kiran</a></cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="http://www.simonecarletti.com/blog/2009/06/capistrano-and-database-yml/#comment-4762">
			September 26, 2009 at 1:57 am</a>		</div>

		<p>This was an awesome post and was really useful in setting up my database.yml. Thank you so much.</p>

		<div class="reply">
		<a class='comment-reply-link' href='/blog/2009/06/capistrano-and-database-yml/?replytocom=4762#respond' onclick='return addComment.moveForm("comment-4762", "4762", "respond", "363")'>Reply</a>		</div>
		</div>
		<div class="comment odd alt thread-odd thread-alt depth-1" id="comment-6336">
				<div class="comment-author vcard">
		<img alt='' src='http://0.gravatar.com/avatar/664e966874d5393b12b103dca6d6be4c?s=32&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D32&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn">Anuradha Mulukutla</cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="http://www.simonecarletti.com/blog/2009/06/capistrano-and-database-yml/#comment-6336">
			November 30, 2009 at 10:54 am</a>		</div>

		<p>This was extremely helpful, thanks! Just a small correction – for the substitutions (including the prompts for the password) to work correctly in the ERB file, I used ruby expression tags &lt;%= &#8230; %&gt; rather than the #{} string interpolation.</p>

		<div class="reply">
		<a class='comment-reply-link' href='/blog/2009/06/capistrano-and-database-yml/?replytocom=6336#respond' onclick='return addComment.moveForm("comment-6336", "6336", "respond", "363")'>Reply</a>		</div>
		</div>
		<div class="comment even thread-even depth-1" id="comment-15805">
				<div class="comment-author vcard">
		<img alt='' src='http://1.gravatar.com/avatar/d32f25ab2112110cebb2ed4b86e87920?s=32&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D32&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn">Pratik Khadloya</cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="http://www.simonecarletti.com/blog/2009/06/capistrano-and-database-yml/#comment-15805">
			October 10, 2010 at 1:01 am</a>		</div>

		<p>Very very helpful. Thanks a lot!</p>

		<div class="reply">
		<a class='comment-reply-link' href='/blog/2009/06/capistrano-and-database-yml/?replytocom=15805#respond' onclick='return addComment.moveForm("comment-15805", "15805", "respond", "363")'>Reply</a>		</div>
		</div>
		<div class="comment odd alt thread-odd thread-alt depth-1 parent" id="comment-33226">
				<div class="comment-author vcard">
		<img alt='' src='http://1.gravatar.com/avatar/fc582698581884352e745d1d4c64699d?s=32&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D32&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn">Josh</cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="http://www.simonecarletti.com/blog/2009/06/capistrano-and-database-yml/#comment-33226">
			June 12, 2011 at 3:34 am</a>		</div>

		<p>Hello! This looks really helpful, but where do I have to save the capistrano_database_yml.rb file? When requiring it in deploy.rb, I&#8217;m getting &#8220;`gem_original_require&#8217;: no such file to load &#8212; capistrano_database_yml.rb&#8221;&#8230;</p>

		<div class="reply">
		<a class='comment-reply-link' href='/blog/2009/06/capistrano-and-database-yml/?replytocom=33226#respond' onclick='return addComment.moveForm("comment-33226", "33226", "respond", "363")'>Reply</a>		</div>
				<div class="comment byuser comment-author-weppos bypostauthor even depth-2" id="comment-33272">
				<div class="comment-author vcard">
		<img alt='' src='http://1.gravatar.com/avatar/99e0b39c091e10d9c7d4452a34ca52dc?s=32&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D32&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn"><a href="http://www.simonecarletti.com/"   rel='external nofollow' class='url'>Simone Carletti</a></cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="http://www.simonecarletti.com/blog/2009/06/capistrano-and-database-yml/#comment-33272">
			June 13, 2011 at 9:35 am</a>		</div>

		<p>You can save it where you want. For example, I usually store all deploy files in a <code>/config/deploy</code> folder.<br />
Make sure the file is in your <code>$LOAD_PATH</code>.</p>

		<div class="reply">
		<a class='comment-reply-link' href='/blog/2009/06/capistrano-and-database-yml/?replytocom=33272#respond' onclick='return addComment.moveForm("comment-33272", "33272", "respond", "363")'>Reply</a>		</div>
		</div>
</div>
		<div class="comment odd alt thread-even depth-1 parent" id="comment-38642">
				<div class="comment-author vcard">
		<img alt='' src='http://1.gravatar.com/avatar/fa6df34739cc5054a47f0ea4c7d64c00?s=32&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D32&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn">Justin Sarma</cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="http://www.simonecarletti.com/blog/2009/06/capistrano-and-database-yml/#comment-38642">
			September 15, 2011 at 11:28 pm</a>		</div>

		<p>Nice tutorial! You can enhance the security a bit by using password_prompt instead of ask. That way no one will see what you type on the screen:</p>
<p>Capistrano::CLI.password_prompt(&#8220;Enter MySQL database password: &#8220;)</p>
<p>Also, it&#8217;s a little off-topic, but the security hole that worries me much more than this is how database.yml has to store DB passwords on the server, so if the web server&#8217;s apache user account is compromised, so is the DB. You could encrypt the password in another file only readable by the Apache user, but the key to unlock it still has to be readable to the Apache user, so it&#8217;s ultimately security through obscurity. This may simply be an unsolvable problem. Gazzang&#8217;s ezNcrypt claims it can solve it with remote key servers, but that&#8217;s quite expensive. Any ideas, anyone?</p>

		<div class="reply">
		<a class='comment-reply-link' href='/blog/2009/06/capistrano-and-database-yml/?replytocom=38642#respond' onclick='return addComment.moveForm("comment-38642", "38642", "respond", "363")'>Reply</a>		</div>
				<div class="comment byuser comment-author-weppos bypostauthor even depth-2" id="comment-38655">
				<div class="comment-author vcard">
		<img alt='' src='http://1.gravatar.com/avatar/99e0b39c091e10d9c7d4452a34ca52dc?s=32&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D32&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn"><a href="http://www.simonecarletti.com/"   rel='external nofollow' class='url'>Simone Carletti</a></cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="http://www.simonecarletti.com/blog/2009/06/capistrano-and-database-yml/#comment-38655">
			September 16, 2011 at 8:48 am</a>		</div>

		<p>Unfortunately it&#8217;s the way Rails works by default.</p>

		<div class="reply">
		<a class='comment-reply-link' href='/blog/2009/06/capistrano-and-database-yml/?replytocom=38655#respond' onclick='return addComment.moveForm("comment-38655", "38655", "respond", "363")'>Reply</a>		</div>
		</div>
</div>
		<div class="comment odd alt thread-odd thread-alt depth-1" id="comment-40469">
				<div class="comment-author vcard">
		<img alt='' src='http://0.gravatar.com/avatar/6e7b88d52b053572a2626a5e36602f7a?s=32&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D32&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn"><a href="http://ideaport.com" onclick="javascript:_gaq.push(['_trackEvent','outbound-commentauthor','http://ideaport.com']);"  rel='external nofollow' class='url'>Andrew</a></cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="http://www.simonecarletti.com/blog/2009/06/capistrano-and-database-yml/#comment-40469">
			November 28, 2011 at 11:55 pm</a>		</div>

		<p>I would like to run a script during deployment &#8212; and the script needs to access the database.</p>
<p>So I&#8217;d like to access database.yml during the deploy and be able to pull out the database access information so as to pass it to the script.</p>
<p>Is there a way to do this? </p>
<p>At the moment I use a .my.cnf file, so the script works with that information, but this is not optimal since I am storing the same information in two places. And it isn&#8217;t the rails way&#8230;</p>

		<div class="reply">
		<a class='comment-reply-link' href='/blog/2009/06/capistrano-and-database-yml/?replytocom=40469#respond' onclick='return addComment.moveForm("comment-40469", "40469", "respond", "363")'>Reply</a>		</div>
		</div>
  </div>

  <div class="navigation">
    <div class="alignleft"></div>
    <div class="alignright"></div>
  </div>
 


<div id="respond">

  <h3>Add a Comment</h3>

  <div class="cancel-comment-reply">
    <small><a rel="nofollow" id="cancel-comment-reply-link" href="/blog/2009/06/capistrano-and-database-yml/#respond" style="display:none;">Click here to cancel reply.</a></small>
  </div>

  
<form action="http://www.simonecarletti.com/blog/wp-comments-post.php" method="post" id="commentform">

    <p>
    <label for="author">Name (required)</label><br />
    <input type="text" name="author" id="author" value="" size="22" tabindex="1" aria-required='true' />
  </p>
  <p>
    <label for="email">Mail (will not be published) (required)</label><br />
    <input type="text" name="email" id="email" value="" size="22" tabindex="2" aria-required='true' />
  </p>
  <p>
    <label for="url">Website</label><br />
    <input type="text" name="url" id="url" value="" size="22" tabindex="3" />
  </p>
  
<!--<p><small><strong>XHTML:</strong> You can use these tags: <code>&lt;a href=&quot;&quot; title=&quot;&quot;&gt; &lt;abbr title=&quot;&quot;&gt; &lt;acronym title=&quot;&quot;&gt; &lt;b&gt; &lt;blockquote cite=&quot;&quot;&gt; &lt;cite&gt; &lt;code&gt; &lt;del datetime=&quot;&quot;&gt; &lt;em&gt; &lt;i&gt; &lt;q cite=&quot;&quot;&gt; &lt;strike&gt; &lt;strong&gt; </code></small></p>-->

  <p>
    <textarea name="comment" id="comment" cols="100%" rows="10" tabindex="4"></textarea>
  </p>

  <p>
    <input name="submit" type="submit" id="submit" tabindex="5" value="Submit" />
    <input type='hidden' name='comment_post_ID' value='363' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
  </p>

  <p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="c4380e5ea9" /></p>
</form>

</div>



    </div>
    <div class="grid_4">
      <div id="sidebar" role="complementary">
  <div id="search-3" class="widget widget_search"><form role="search" method="get" id="searchform" action="http://www.simonecarletti.com/blog/">
<div>
  <input type="text" value="" name="s" id="s" style="width: 70%" />
  <input type="submit" id="searchsubmit" value="Search" style="width: 25%" />
</div>
</form></div><div id="text-316128859" class="widget widget_text">			<div class="textwidget"><div style="background-color: #FFFFCC; border: 1px solid #FFFF00; padding: 1em;"><p><a href="http://www.robodomain.com/?utm_source=simonecarletti.com&utm_medium=banner&utm_content=sidebar-single&utm_campaign=robodomain" title="RoboDomain"><img src="http://www.simonecarletti.com/blog/wp-content/uploads/2009/12/robodomain-icon.png" alt="RoboDomain" class="alignleft" />
<h3>RoboDomain</h3>
Track and manage your domains in one single place: log transactions, add notes and more</a></p>
</div></div>
		</div><div id="text-316128860" class="widget widget_text"><h6 class="widgettitle">Teach Me</h6>			<div class="textwidget"><p>As you might know (or have figured out by reading this website), I am not a native English speaker. If you spot an error, or if you think that something can be expressed in a better way, please <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;%73%69%6d%6f%6e%65+%65%6e%67%6c%69%73%68@%63%61%72%6c%65%74%74%69.%6e%61%6d%65">let me know</a> so that I can fix the issue and learn from my mistakes.</p></div>
		</div><div id="text-316128861" class="widget widget_text"><h6 class="widgettitle">Hire Me</h6>			<div class="textwidget"><p>I'm currently available for consulting, development or speech opportunities. I prefer short, catchy projects. Feel free to <a href="mailto:%73%69%6d%6f%6e%65@%63%61%72%6c%65%74%74%69.%6e%61%6d%65">email me</a> if you'd like to hire me or just get in touch.</p></div>
		</div>      <div id="weppos_summary_widget-4" class="widget widget-weppos-summary">        <h6 class="widgettitle">Subscribe</h6>        <ul class="subscribe">
          <li class="feed"><a href="http://www.simonecarletti.com/blog/feed/">Subscribe via RSS</a></li>
          <li class="twitter"><a href="http://twitter.com/weppos">Follow on Twitter</a></li>
        </ul>
      </div>    <!-- Wordpress Popular Posts Plugin v2.2.1 [W] [monthly] [regular] -->
<div id="wpp-3" class="widget popular-posts">
<h6 class="widgettitle">Popular Posts</h6><ul>
<li><a href="http://www.simonecarletti.com/blog/2010/06/unobtrusive-javascript-in-rails-3/" title="Unobtrusive JavaScript in Rails 3"><span class="wpp-post-title">Unobtrusive JavaScript in Rails 3</span></a> </li>
<li><a href="http://www.simonecarletti.com/blog/2010/04/inside-ruby-on-rails-serializing-ruby-objects-with-json/" title="Understanding Ruby and Rails: Serializing Ruby objects with JSON"><span class="wpp-post-title">Understanding Ruby and Rails: Serializing Ruby objects with JSON</span></a> </li>
<li><a href="http://www.simonecarletti.com/blog/2011/05/configuring-rails-3-https-ssl/" title="Configuring Rails 3 to use HTTPS and SSL"><span class="wpp-post-title">Configuring Rails 3 to use HTTPS and SSL</span></a> </li>
<li><a href="http://www.simonecarletti.com/blog/2009/01/apache-rewriterule-and-query-string/" title="Apache RewriteRule and query string"><span class="wpp-post-title">Apache RewriteRule and query string</span></a> </li>
<li><a href="http://www.simonecarletti.com/blog/2009/01/apache-query-string-redirects/" title="Apache .htaccess query string redirects"><span class="wpp-post-title">Apache .htaccess query string redirects</span></a> </li>

</ul>
</div>
<!-- End Wordpress Popular Posts Plugin v2.2.1 -->
 
  </div>

    </div>
  </div>

  <div class="wrap">
    <div id="prefooter" class="container_12 clearfix">
                  <div id="widget-weppos-aboutme" class="grid_4">
        <h6>Follow Me</h6>
        <ul id="twitter_update_list"></ul>
        <script type="text/javascript" src="http://twitter.com/javascripts/blogger.js"></script>
        <script type="text/javascript" src="http://twitter.com/statuses/user_timeline/weppos.json?callback=twitterCallback2&count=3"></script>
      </div>
            <div id="recent-comments-3" class="widget widget_recent_comments grid_4"><h6 class="widgettitle">Recent Comments</h6><ul id="recentcomments"><li class="recentcomments"><a href="http://www.supplychaindigital.com" onclick="javascript:_gaq.push(['_trackEvent','outbound-commentauthor','http://www.supplychaindigital.com']);"  rel='external nofollow' class='url'>Kyaw Yel</a> on <a href="http://www.simonecarletti.com/blog/2009/01/apache-query-string-redirects/#comment-40525">Apache .htaccess query string redirects</a></li><li class="recentcomments">manoj menon on <a href="http://www.simonecarletti.com/blog/2009/04/tabsonrails/#comment-40510">TabsOnRails: creating and managing Tabs with Ruby on Rails</a></li><li class="recentcomments">Daniel on <a href="http://www.simonecarletti.com/blog/2009/10/actionmailer-and-host-value/#comment-40487">How to pass request context to ActionMailer and supply the :host value to url_for</a></li><li class="recentcomments"><a href="http://www.simonecarletti.com/"   rel='external nofollow' class='url'>Simone Carletti</a> on <a href="http://www.simonecarletti.com/blog/2009/09/ruby-whois-preview-answer-and-parser/#comment-40479">Ruby Whois preview: WHOIS answer and parser</a></li><li class="recentcomments"><a href="http://anuragsaxena.in" onclick="javascript:_gaq.push(['_trackEvent','outbound-commentauthor','http://anuragsaxena.in']);"  rel='external nofollow' class='url'>Anurag Saxena</a> on <a href="http://www.simonecarletti.com/blog/2009/09/ruby-whois-preview-answer-and-parser/#comment-40478">Ruby Whois preview: WHOIS answer and parser</a></li></ul></div>            <div id="widget-quotes" class="grid_4">
        <h6>Random Quote</h6>
        <div id="randomquote" class="clearfix">
        </div>
      </div>
          </div>
  </div>

  <div id="footer" class="container_12 clearfix">
    <div id="copy">
      Copyright &copy; 2003-2011 Simone Carletti, All Rights Reserved<br />
      Content on this blog is licensed under a <a href="http://creativecommons.org/licenses/by-nc-sa/2.5/">Creative Commons</a> license.
    </div>
  </div>

  		<!-- Advertising Manager v3.4.19 (0.635 seconds.) -->
</body>
</html>
<!-- Dynamic page generated in 0.630 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2011-12-24 22:59:48 -->
